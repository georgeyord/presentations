<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Tripsta - Brand integration</title>

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="../reveal/css/reveal.css">
		<link rel="stylesheet" href="../reveal/css/theme/moon.css" id="theme">
		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="../reveal/lib/css/zenburn.css">
		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? '../reveal/css/print/pdf.css' : '../reveal/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
		<!--[if lt IE 9]>
		<script src="../reveal/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>


    <div class="reveal">
    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
    <section>
        <h1>Brand integration</h1>
        <h3>Simulate and evaluate 2 solutions</h3>
        <p>
            <small><a href="https://github.com/tripsta/app/wiki/Integration-of-Brand-in-TP24-app">Full wiki</a></small>
        </p>
    </section>

    <section>
        <section>
            <h1>New entities</h1>
        </section>
        <section>
            <h2>Market</h2>
            <img data-src="http://www.sweetcounter.co.uk/images/products/flags9yc.jpg">
        </section>
        <section>
            <h2>Brand</h2>
            <table>
                <tr><td>
                    <img width="500" data-src="http://www.infocom.gr/wp-content/uploads/2014/03/travelplanet24_logo.jpg">
                </td>
                    <td>
                        <img width="500" data-src="http://static.kodyrabatowe.pl/filemanager/f/Tripsta1.jpg">
                    </td>
                    <td>
                        <img width="500" data-src="http://www.breakthroughgreece.gr/wp-content/uploads/airtick_590x260-590x260.png">
                    </td>
                </tr>
            </table>
        </section>
        <section>
            <h2>Market + Brand = </h2>
            <h1 class="fragment">Wing</h1>
        </section>
        <section>
            <h2>Brand table</h2>
            <table>
                <thead>
                <tr>
                    <th>BrandID</th>
                    <th>Name</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>1</td>
                    <td>tripsta</td>
                <tr>
                <tr>
                    <td>2</td>
                    <td>travelplanet24</td>
                <tr>
                <tr>
                    <td>3</td>
                    <td>airtickets</td>
                <tr>
                </tbody>
            </table>
        </section>
        <section>
            <h2>Market table</h2>
            <table>
                <thead>
                <tr>
                    <th>MarketID</th>
                    <th>Name</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>1</td>
                    <td>gr</td>
                <tr>
                <tr>
                    <td>2</td>
                    <td>de</td>
                <tr>
                </tbody>
            </table>
        </section>
        <section>
            <h2>Wing table</h2>
            <table>
                <thead>
                <tr>
                    <th>WingID</th>
                    <th>BrandID</th>
                    <th>MarketID</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>1011</td>
                    <td>1</td>
                    <td>11</td>
                <tr>
                <tr>
                    <td>2002</td>
                    <td>2</td>
                    <td>2</td>
                <tr>
                </tbody>
            </table>
        </section>
    </section>

    <section>
        <h2>Questions</h2>
        <ul style="text-align: left;">
            <li class="fragment">Should we use wingId, marketId or BrandId in existing tables like Booking?</li>
            <li class="fragment">Is it faster to have two columns (marketId/BrandId) or one (wingId)?</li>
            <li class="fragment">Is it faster to have two joins (marketId/BrandId) or a triple one (wingId)?</li>
            <li class="fragment">Should we enforce the use of the marketId/BrandId pair or leave to developers' implementation?</li>
        </ul>
    </section>

    <section>
        <section>
            <h2>Let's evaluate 2 solutions</h2>
        </section>
        <section>
            <h2>Solution 1</h2>
            <ul style="text-align: left;">
                <li class="fragment">Use of WingId in every table that needs both Market and Brand</li>
                <li class="fragment">Use of MarketId or BrandId in any table that needs only the specific reference</li>
                <li class="fragment">Use of MarketId AND BrandId in cases, like Service Fee Rules, that one of the two might be optional</li>
                <li class="fragment">Use of Market and Brand is enforced by using WingId</li>
                <li class="fragment">One index per table on WingId</li>
            </ul>
        </section>
        <section>
            <h2>Solution 2</h2>
            <ul style="text-align: left;">
                <li class="fragment">Use in all tables the BrandID and the MarketID columns</li>
                <li class="fragment">Wing table will be used as a reference of the valid Market/Brand pairs without functional use</li>
                <li class="fragment">Use of Market <b>and</b> Brand is left to the developer to decide</li>
                <li class="fragment">3 indices per table on MarketID, BrandID and the compound MarketID/BrandID</li>
            </ul>
        </section>
    </section>

    <section>
        <h2>Preparation</h2>
        <ul style="text-align: left;">
            <li class="fragment">Use dbstage1.tripsta.net, a machine with hardware to support the live db</li>
            <li class="fragment">Create 2 copies of Booking table with live data</li>
            <li class="fragment">Create the 3 tables needed: Wing, Brand, Market</li>
            <li class="fragment">Booking1: add windID column and add the index IX_Booking_WingID.</li>
            <li class="fragment">Booking2: add marketID, brandID columns and add the indices IX_Booking_MarketID_BrandID (compound), IX_Booking_MarketID, IX_Booking_BrandID</li>
        </ul>
    </section>

    <section style="text-align: left;">
        <section>
            <h2>Run the queries</h2>
        </section>
        <section>
            <h3>Query 1 - LEGACY usage (wing column)</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
FROM Booking bk
WHERE bk.wing = 'gr';</code></pre>
            <h4>Duration: 0.76</h4>
        </section>
        <section>
            <h3>Query 2 - Case 1 with JOINS</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
FROM Booking1 bk
JOIN Wing w ON bk.wingID = w.wingID
JOIN Market m ON w.marketID = m.marketID
JOIN Brand b ON w.brandID = b.brandID
WHERE m.name = 'gr' AND b.name = 'travelplanet24';</code></pre>
            <h4>Duration: 0.49</h4>
        </section>
        <section>
            <h3>Query 3 - Case 1 without JOINS</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
FROM Booking1 bk WHERE bk.wingID = 2002;</code></pre>
            <h4>Duration: 0.49</h4>
        </section>
        <section>
            <h3>Query 4 - Case 1 with JOINS market only</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
FROM Booking1 bk
JOIN Wing w ON bk.wingID = w.wingID
JOIN Market m ON w.marketID = m.marketID
WHERE m.name = 'gr';</code></pre>
            <h4>Duration: 0.49</h4>
        </section>
        <section>
            <h3>Query 5 - Case 2 with JOINS</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
FROM Booking2 bk FORCE INDEX (IX_Booking_MarketID_BrandID)
JOIN Market m ON bk.marketID = m.marketID
JOIN Brand b ON bk.brandID = b.brandID
WHERE m.name = 'gr' AND b.name = 'travelplanet24';</code></pre>
            <h4>Duration: 0.58</h4>
        </section>
        <section>
            <h3>Query 6 - Case 2 without JOINS</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
    FROM Booking2 bk FORCE INDEX (IX_Booking_MarketID_BrandID)
    WHERE bk.marketID = 2 AND bk.brandID = 2;</code></pre>
            <h4>Duration: 0.57</h4>
        </section>
        <section>
            <h3>Query 7 - Case 2 without JOINS market only</h3>
                        <pre><code class="html">SELECT SQL_NO_CACHE count(*)
Booking2 bk WHERE bk.marketID = 2;</code></pre>
            <h4>Duration: 0.50</h4>
        </section>
    </section>


    <section>
        <section>
            <h2>Main findings</h2>
            <p align="left">Any solution is FASTER than using wing column because the later is a varchar.</p>
            <small class="fragment">Query 1 vs 2 or 6</small>
            <p class="fragment" align="left">In any Solution using the JOINed tables or setting the values hardcoded makes *no* difference in time.</p>
            <p class="fragment"><small>Why? The loading of these few data/rows is very fast. Query 2 vs 3, Query 5 vs 6</small></p>
            <p class="fragment" align="left">Solution 1 is faster by 10ms from Solution 2 even if it has a triple join. </p>
            <p class="fragment"><small>Why? The key length of windId is 4 but the 2 columns have a key length 8 Query 2 vs 5</small></p>
        </section>

        <section>
            <h2>More findings</h2>
            <p align="left">Solution 2: Schema alteration takes double the time because of the 3 indices</p>
            <p class="fragment" align="left">All updates of windID, brandID or makretID run 30% faster when we disable unique_checks and foreign_key_checks.</p>
            <p class="fragment" align="left">In Booking2 table where we added marketId and brandID, the query did not use the compound index but the insection of the 2 single indices which created a decline in performance. We forced the use of the compound index to have the final recorded time.</p>
            <p class="fragment" align="left">The update of the new wingID breaks with a Percona related error 5. We split the updates per market.</p>
        </section>
    </section>

    <section>
        <h1>Conclusion</h1>
        <p align="left">Use of WingId in every table that needs both Market and Brand</p>
        <p align="left">Use of MarketId or BrandId in any table that needs only the specific reference</p>
        <p align="left">Use of MarketId AND BrandId in cases, like Service Fee Rules, that one of the two might be optional</p>
        <p align="left">Use of Market and Brand is enforced by using WingId</p>
    </section>
    </div>

    </div>

		<script src="../reveal/lib/js/head.min.js"></script>
		<script src="../reveal/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: '../reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: '../reveal/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '../reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: '../reveal/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: '../reveal/plugin/zoom-js/zoom.js', async: true },
					{ src: '../reveal/plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
